---
title: "ae-listing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ae-listing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(metalite.ae)
library(metalite)
library(r2rtf)
devtools::load_all()
```

```{r}
adae <- r2rtf::r2rtf_adae
adsl <- r2rtf::r2rtf_adsl
```

## Overview

### Data Manipulation

#### Sample code for AE related

```{r}
adae$related <- ifelse(adae$AEREL == 'RELATED', "Y", ifelse(
      toupper(adae$AEREL) == 'NOT RELATED', "N",  tools::toTitleCase(tolower(adae$AEREL))
    ))
head(adae$related)
```

#### Sample code for outcome

```{r}
for(i in 1:length(adae$AEOUT)){
adae$outcome <-  switch(adae$AEOUT[i],
                        "RECOVERED/RESOLVED" = 'Resolved',
                        'RECOVERING/RESOLVING'='Resolving',
                        'RECOVERED/RESOLVED WITH SEQUELAE'='Sequelae',
                        'NOT RECOVERED/NOT RESOLVED'= 'Not Resolved',
                        tools::toTitleCase(tolower(adae$AEOUT[i]))
      )
}
```

#### Sample code for duration

```{r}

adae$duration <- paste(ifelse(is.na(adae$ADURN), "", as.character(adae$ADURN)) ,tools::toTitleCase(tolower(adae$ADURU)),sep=" ")# AE duration with unit

    for(i in 1:length(adae$duration)){
      if(is.na(adae$ADURN[i])){
        adae$duration[i] <- ifelse(charmatch(toupper(adae$AEOUT[i]), 'RECOVERING/RESOLVING')>0 |
                                    charmatch(toupper(adae$AEOUT[i]), 'NOT RECOVERED/NOT RESOLVED')>0, 'Continuing', 'Unknown')
      }
    }

```

#### Sample code for subline

```{r}
adae$subline <- paste0(
      "Subject ID = ", adae$USUBJID,
      ", Gender = ", adae$SEX,
      ", Race = ", adae$RACE,
      ", AGE = ", adae$AGE, " Years",
      ", TRT = ", adae$TRTA
    )
```

### Customize variable label as the column header of AE listing 

```{r}
adae <- assign_label(adae, 
                     var = c("related", "outcome", "duration", "AESEV", "AESER", "AEDECOD"), 
                     label = c("Related", "Outcome", "Duration", "Intensity", "Serious", "Adverse Event") )

```

### Analysis preparation

```{r}
meta_ae_listing <- function() {
  adsl$TRTA <- adsl$TRT01A
  adsl$TRTA <- factor(adsl$TRTA,
    levels = c("Placebo", "Xanomeline Low Dose", "Xanomeline High Dose"),
    labels = c("Placebo", "Low Dose", "High Dose")
  )

  adae$TRTA <- factor(adae$TRTA,
    levels = c("Placebo", "Xanomeline Low Dose", "Xanomeline High Dose"),
    labels = c("Placebo", "Low Dose", "High Dose")
  )

  plan <- plan(
      analysis = "ae_listing", population = "apat",
      observation = c("wk12", "wk24"), parameter = c("any",  "rel", "ser")
    ) 

  meta_adam(
    population = adsl,
    observation = adae
  ) |>
    define_plan(plan = plan) |>
    define_population(
      name = "apat",
      group = "TRTA",
      subset = quote(SAFFL == "Y")
    ) |>
    define_observation(
      name = "wk12",
      group = "TRTA",
      subset = quote(SAFFL == "Y"),
      label = "Weeks 0 to 12",
      rel_day = "ASTDY"
    ) |>
    define_observation(
      name = "wk24",
      group = "TRTA",
      subset = quote(AOCC01FL == "Y"), # just for demo, another flag shall be used.
      label = "Weeks 0 to 24",
      rel_day = "ASTDY"
    ) |>
    define_parameter(
      name = "rel",
      subset = quote(AEREL %in% c("POSSIBLE", "PROBABLE"))
    ) |>
    define_parameter(
      name = "ser",
      subset = quote(AESER == "Y")
    ) |>
    define_analysis(
      name="ae_listing",
      var_name = c("USUBJID", "ASTDY", "AEDECOD", "duration", "AESEV", "AESER", "related", "outcome"),
      subline = "subline",
      subline_by = NULL,
      group_by = c("USUBJID", "ASTDY"),
      page_by = c("TRTA", "subline")
    ) |>
    meta_build()
}
```

```{r}
meta <- meta_ae_listing()
prepare_ae_listing(meta, "apat", "wk12", "ser") |> 
tlf_ae_listing(path_outtable ="outtable/ae_listing.rtf", 
               path_outdata="outtable/ae_listing.rdata")
```