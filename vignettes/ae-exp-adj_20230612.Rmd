---
title: "Exposure-Adjusted Adverse Event Summary (Updated)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exposure-Adjusted Adverse Event Summary}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
resource_files:
   - fig/*.png
   - rtf/*.rtf
   - pdf/*.pdf
---

```{r,echo=FALSE,warning=FALSE, message=FALSE}
library(metalite)
library(metalite.ae)
library(dplyr)
```
 

####  1. Data pretreatment 

```{r,echo=FALSE,warning=FALSE, message=FALSE}
# ADSL
adsl <- r2rtf::r2rtf_adsl
adsl$TRTA <- adsl$TRT01A
adsl$TRTA <- factor(adsl$TRTA,
                    levels = c("Placebo", "Xanomeline Low Dose", "Xanomeline High Dose"),
                    labels = c("Placebo", "Low Dose", "High Dose"))
# ADAE
adae <- r2rtf::r2rtf_adae
adae$TRTA <- factor(adae$TRTA,
                    levels = c("Placebo", "Xanomeline Low Dose", "Xanomeline High Dose"),
                    labels = c("Placebo", "Low Dose", "High Dose"))

# Drug-related AE values
adae$related <- ifelse(
  adae$AEREL == "RELATED",
  "Y",
  ifelse(
    toupper(adae$AEREL) == "NOT RELATED",
    "N",
    tools::toTitleCase(tolower(adae$AEREL))
    )
)

# AE outcome
for (i in seq_along(adae$AEOUT)) {
  adae$outcome <- switch(adae$AEOUT[i],
                         "RECOVERED/RESOLVED" = "Resolved",
                         "RECOVERING/RESOLVING" = "Resolving",
                         "RECOVERED/RESOLVED WITH SEQUELAE" = "Sequelae",
                         "NOT RECOVERED/NOT RESOLVED" = "Not Resolved",
                         tools::toTitleCase(tolower(adae$AEOUT[i]))
                         )
}

# AE action
adae$AEACN <- gsub("", "DOSE NOT CHANGED", adae$AEACN)

for (i in seq_along(adae$AEACN)) {
  adae$action_taken[i] <- switch(adae$AEACN[i],
                                 "DOSE NOT CHANGED" = "None",
                                 "DOSE REDUCED" = "Reduced",
                                 "DRUG INTERRUPTED" = "Interrupted",
                                 "DOSE INCREASED" = "Increased",
                                 "NOT APPLICABLE" = "N/A",
                                 "UNKNOWN" = "Unknown",
                                 "''" = "None",
                                 tools::toTitleCase(tolower(adae$AEACN[i]))
                                 )
}

# AE duration with unit
adae$duration <- paste(
  ifelse(
    is.na(adae$ADURN),
    "",
    as.character(adae$ADURN)
    ),
  tools::toTitleCase(tolower(adae$ADURU)),
  sep = " "
)

for (i in seq_along(adae$duration)) {
  if (is.na(adae$ADURN[i])) {
    adae$duration[i] <- ifelse(
      charmatch(toupper(adae$AEOUT[i]), "RECOVERING/RESOLVING") > 0 |
        charmatch(toupper(adae$AEOUT[i]), "NOT RECOVERED/NOT RESOLVED") > 0,
      "Continuing",
      "Unknown"
      )
  }
}

# Assign label
adae <- metalite::assign_label(adae,
                               var = c("related", "outcome", "duration", "AESEV", "AESER", "AEDECOD", "action_taken"),
                               label = c("Related", "Outcome", "Duration", "Intensity", "Serious", "Adverse Event", "Action Taken")
)
```
At the end of this step, adae is created.(See .Rmd file for codes)
```{r,include=FALSE}
head(adae)
```

####  2. Build a metadata 

```{r,echo=FALSE,warning=FALSE, message=FALSE}
meta <- meta_ae_example(
  population_in        = "apat",
  analysis_in          = "ae_exp_adj",
  analysis_title_in    = "Exposure-Adjusted Adverse Event Summary",
  observation_in       = c("wk12","wk24"),
  observation_label_in = c("Weeks 0 to 12","Weeks 0 to 24"),
  parameter_in         = "any;rel;ser"
)
```
At the end of this step, 'meta' is created.(See .Rmd file for codes)
```{r}
meta
```


#### 3.Call function prepare_ae_exp_adj() --- Function updated by Bing (--To Be Discussed.)

```{r}
# Run the new function
x <- prepare_ae_exp_adj(meta,
                        population = "apat",
                        observation = "wk12",
                        parameter = "any;rel;ser",
                        adj_unit = "month")

# x$n
# x$total_exposure
# x$parameter
x$adj_rate
```
 
#### 4. Function Explanation Step by Step

step 1. Define values

```{r}
meta        =  meta
population  = "apat" 
observation = "wk12" 
parameter   = "any;rel;ser" 
adj_unit    = "month"

```

step 2.   obtain variables

```{r,error=TRUE,message=FALSE,warning=FALSE}
time_unit <- list("year" = 365.24, "month" = 30.4367, "week" = 7, "day" = 1)
# adj_unit <- match.arg(adj_unit)  # Q : What does match.arg() do? --> error message
exp_factor <- 100 * time_unit[[adj_unit]]  # 3043.67

  ### xxxx

  # obtain variables
  pop_var <- collect_adam_mapping(meta, population)$var          ;# TRTDUR
  obs_var <- collect_adam_mapping(meta, observation)$var         ;# NULL
  par_var <- collect_adam_mapping(meta, parameter)$var           ;# NULL
  par_soc <- collect_adam_mapping(meta, parameter)$soc           ;# NULL

  pop_group <- collect_adam_mapping(meta, population)$group      ;# TRTA
  obs_group <- collect_adam_mapping(meta, observation)$group     ;# TRTA

  pop_id <- collect_adam_mapping(meta, population)$id            ;# USUBJID
  obs_id <- collect_adam_mapping(meta, observation)$id           ;# USUBJID
  
  # Q : NULLs for obs_var,par_var,par_soc?
```
 

step 3. obtain data 'pop' and 'obs'

```{r}
  # obtain data
  pop <- collect_population_record(meta, population, var = pop_var)
  obs <- collect_observation_record(meta, population, observation, parameter, var = unique(c(obs_var, par_var, par_soc)))
  head(pop);head(obs)
```


step 4. $(1)$ get n -- number of subjects exposed  (validated)

```{r}
  # number of Subjects exposed
n_exposed <- metalite:::n_subject(id = pop[[pop_id]], group = pop[[pop_group]])   ;
n_exposed
```

step 4. $(2)$ get total_exposure (validated)

```{r}
  # total exposure in person-year/month/week/day
  total_exposure <- aggregate(pop$TRTDUR, by = list(pop[[pop_group]]), FUN = sum)
  names(total_exposure) <- c("group", "tol_exp")
  total_exposure
```

step 4. $(3)$ define parameters (validated)

```{r}
parameters <- unlist(strsplit(parameter, ";"))  ;parameters
```

step 4. $(4)$ get adj_rate (to be discussed)
 
<br>
- Take "100-person-month" rate as an example.

<br>
- Current definition: 

<br>
EAER (100 person month) = total number of event * exp_factor(=3043.67) / total_exposure_days (per TrtGrp), where the total number of events is computed by nrow(meta$data_observation) --- this is the total number of AE including all treatment groups (which might not be correct).

<br>
- Propose new definition:

$$
\begin{aligned}
EAER_j (100~person-month) 
&=\frac{total~number~of~events~for~Trt_j}{total~person-day~for~Trt_j/(100*30.4367)}  \\
&=\frac{total~number~of~events~for~Trt_j * exp~factor(=3043.67)}{total~person-day~for~Trt_j}
\end{aligned}
$$
- Issue/Difference: 
<br>
Same denominator, but different numerators.--- The current formulas count the total number of events for all Trt Groups.
<br>
- Suggest: 
<br>
Change the numberator to count the number of events per Trt Group j.
 
$(a)$ ANY AE adj rate  

```{r }
# current formula:
x="any"
ans <- nrow(meta$data_observation) * exp_factor / total_exposure$tol_exp; ans   
``` 
```{r}
# propose new formula -- define new numerator 'num':
data = meta$data_observation
num  = ( data |> group_by(get(obs_group)) 
              |> summarise(n()) )$'n()'     #  301 435 455
ans  = num * exp_factor/total_exposure$tol_exp; ans   
```


$(b)$ SER AE adj rate  
```{r }
# current formula
x="ser"
temp <- rlang::eval_tidy(
        expr = collect_adam_mapping(meta, x)$subset,   # AESER == "Y"
        data = meta$data_observation                   # dim(data) = 1191   59
      )
ans <- sum(temp) * exp_factor / total_exposure$tol_exp  ;ans
```
 
```{r }
# propose new formula

x="ser"
data    = meta$data_observation    
TrtGrps = levels( data |> pull(obs_group) )  # "Placebo"   "Low Dose"  "High Dose
J       = length(TrtGrps)                    # number of Trt Groups = 3
num     = rep(NA,J)

for( j in 1:J ){
      expr   = collect_adam_mapping(meta, x)$subset   # AESER == "Y"
      data_j = meta$data_observation |> filter(get(obs_group) == TrtGrps[j] )
      temp_j = rlang::eval_tidy(expr=expr,data=data_j)
      num[j] = sum(temp_j)
}

ans <- num * exp_factor / total_exposure$tol_exp  ;ans
```


<br>
$(c)$  REL AE adj rate  

```{r }
# current formula
x="rel"
temp <- rlang::eval_tidy(
        expr = collect_adam_mapping(meta, x)$subset,   # AESER == "Y"
        data = meta$data_observation                   # dim(data) = 1191   59
      )
ans <- sum(temp) * exp_factor / total_exposure$tol_exp  ;ans
```
<br>
```{r }
# propose new formula

x="rel"
TrtGrps = levels( data |> pull(obs_group) )  # "Placebo"   "Low Dose"  "High Dose
J       = length(TrtGrps)                    # number of Trt Groups = 3
num     = rep(NA,J)

for( j in 1:J ){
      expr   = collect_adam_mapping(meta, x)$subset   # AEREL %in% c("POSSIBLE", "PROBABLE")
      data_j = meta$data_observation |> filter(get(obs_group) == TrtGrps[j] )
      temp_j = rlang::eval_tidy(expr=expr,data=data_j)
      num[j] = sum(temp_j)
}

ans <- num * exp_factor / total_exposure$tol_exp  ;ans
```
  